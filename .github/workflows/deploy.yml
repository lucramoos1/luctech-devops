name: Deploy TechFlow

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Job 1: Validação de Qualidade
  validate:
    name: Validar Projeto
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Verificar estrutura de arquivos
        run: |
          test -f index.html || (echo "Erro: index.html não encontrado" && exit 1)
          test -f styles.css || (echo "Erro: styles.css não encontrado" && exit 1)
          test -f main.js || (echo "Erro: main.js não encontrado" && exit 1)

      - name: Validar HTML5 (W3C Validator)
        uses: cygnetdigital/html5validator-action@master
        with:
          root: ./
          blacklist: node_modules

  # Job 2: Deploy para GitHub Pages
  deploy-gh-pages:
    name: Deploy GitHub Pages
    needs: validate
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Deploy para GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          # Mantém o histórico limpo e evita commits duplicados
          force_orphan: true 

  # Job 3: Notificação de Status
  notify:
    name: Notificar Status
    needs: [validate, deploy-gh-pages]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Status
        run: |
          if [ "${{ needs.deploy-gh-pages.result }}" == "success" ]; then
            echo "✅ Deployment realizado com sucesso!"
          else
            echo "❌ Falha no processo de CI/CD."
          fi